/**
    * @license
    * Copyright 2020 Google LLC. All Rights Reserved.
    * Licensed under the Apache License, Version 2.0 (the "License");
    * you may not use this file except in compliance with the License.
    * You may obtain a copy of the License at
    *
    * http://www.apache.org/licenses/LICENSE-2.0
    *
    * Unless required by applicable law or agreed to in writing, software
    * distributed under the License is distributed on an "AS IS" BASIS,
    * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    * See the License for the specific language governing permissions and
    * limitations under the License.
    * =============================================================================
    */
import{ones,scalar,tidy,tensor2d,util}from"@tensorflow/tfjs-core";import{loadGraphModel}from"@tensorflow/tfjs-converter";function __awaiter(t,e,n,r){return new(n||(n=Promise))(function(o,i){function s(t){try{a(r.next(t))}catch(t){i(t)}}function u(t){try{a(r.throw(t))}catch(t){i(t)}}function a(t){t.done?o(t.value):new n(function(e){e(t.value)}).then(s,u)}a((r=r.apply(t,e||[])).next())})}function __generator(t,e){var n,r,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function u(i){return function(u){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,r=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=(o=s.trys).length>0&&o[o.length-1])&&(6===i[0]||2===i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=e.call(t,s)}catch(t){i=[6,t],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,u])}}}function __values(t){var e="function"==typeof Symbol&&t[Symbol.iterator],n=0;return e?e.call(t):{next:function(){return t&&n>=t.length&&(t=void 0),{value:t&&t[n++],done:!t}}}}function __read(t,e){var n="function"==typeof Symbol&&t[Symbol.iterator];if(!n)return t;var r,o,i=n.call(t),s=[];try{for(;(void 0===e||e-- >0)&&!(r=i.next()).done;)s.push(r.value)}catch(t){o={error:t}}finally{try{r&&!r.done&&(n=i.return)&&n.call(i)}finally{if(o)throw o.error}}return s}var SEPERATOR="‚ñÅ",UNK_INDEX=100,CLS_INDEX=101,CLS_TOKEN="[CLS]",SEP_INDEX=102,SEP_TOKEN="[SEP]",NFKC_TOKEN="NFKC",VOCAB_BASE="https://tfhub.dev/tensorflow/tfjs-model/mobilebert/1/",VOCAB_URL=VOCAB_BASE+"processed_vocab.json?tfjs-format=file",TrieNode=function(){function t(t){this.key=t,this.children={},this.end=!1}return t.prototype.getWord=function(){for(var t=[],e=this;null!=e;)null!=e.key&&t.unshift(e.key),e=e.parent;return[t,this.score,this.index]},t}(),Trie=function(){function t(){this.root=new TrieNode(null)}return t.prototype.insert=function(t,e,n){var r,o,i=this.root,s=[];try{for(var u=__values(t),a=u.next();!a.done;a=u.next()){var l=a.value;s.push(l)}}catch(t){r={error:t}}finally{try{a&&!a.done&&(o=u.return)&&o.call(u)}finally{if(r)throw r.error}}for(var c=0;c<s.length;c++)null==i.children[s[c]]&&(i.children[s[c]]=new TrieNode(s[c]),i.children[s[c]].parent=i),i=i.children[s[c]],c===s.length-1&&(i.end=!0,i.score=e,i.index=n)},t.prototype.find=function(t){for(var e=this.root,n=0;n<t.length&&null!=e;)e=e.children[t[n]],n++;return e},t}();function isWhitespace(t){return/\s/.test(t)}function isInvalid(t){return 0===t.charCodeAt(0)||65533===t.charCodeAt(0)}var punctuations="[~`!@#$%^&*(){}[];:\"'<,.>?/\\|-_+=";function isPunctuation(t){return-1!==punctuations.indexOf(t)}var BertTokenizer=function(){function t(){}return t.prototype.load=function(){return __awaiter(this,void 0,void 0,function(){var t,e,n;return __generator(this,function(r){switch(r.label){case 0:return t=this,[4,this.loadVocab()];case 1:for(t.vocab=r.sent(),this.trie=new Trie,e=999;e<this.vocab.length;e++)n=this.vocab[e],this.trie.insert(n,1,e);return[2]}})})},t.prototype.loadVocab=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2,util.fetch(VOCAB_URL).then(function(t){return t.json()})]})})},t.prototype.processInput=function(t){for(var e=this,n=[],r=0,o=this.cleanText(t,n).split(" ").map(function(t){t=t.toLowerCase();var o=e.runSplitOnPunc(t,r,n);return r+=t.length+1,o}),i=[],s=0;s<o.length;s++)i=i.concat(o[s]);return i},t.prototype.cleanText=function(t,e){var n,r,o=[],i=0,s=0;try{for(var u=__values(t),a=u.next();!a.done;a=u.next()){var l=a.value;if(isInvalid(l))i+=l.length;else{if(isWhitespace(l)){if(!(o.length>0&&" "!==o[o.length-1])){i+=l.length;continue}o.push(" "),e[s]=i,i+=l.length}else o.push(l),e[s]=i,i+=l.length;s++}}}catch(t){n={error:t}}finally{try{a&&!a.done&&(r=u.return)&&r.call(u)}finally{if(n)throw n.error}}return o.join("")},t.prototype.runSplitOnPunc=function(t,e,n){var r,o,i=[],s=!0;try{for(var u=__values(t),a=u.next();!a.done;a=u.next()){var l=a.value;isPunctuation(l)?(i.push({text:l,index:n[e]}),e+=l.length,s=!0):(s&&(i.push({text:"",index:n[e]}),s=!1),i[i.length-1].text+=l,e+=l.length)}}catch(t){r={error:t}}finally{try{a&&!a.done&&(o=u.return)&&o.call(u)}finally{if(r)throw r.error}}return i},t.prototype.tokenize=function(t){var e,n,r=[],o=this.processInput(t);o.forEach(function(t){t.text!==CLS_TOKEN&&t.text!==SEP_TOKEN&&(t.text=""+SEPERATOR+t.text.normalize(NFKC_TOKEN))});for(var i=0;i<o.length;i++){var s=[];try{for(var u=(e=void 0,__values(o[i].text)),a=u.next();!a.done;a=u.next()){var l=a.value;s.push(l)}}catch(t){e={error:t}}finally{try{a&&!a.done&&(n=u.return)&&n.call(u)}finally{if(e)throw e.error}}for(var c=!1,h=0,f=[],p=s.length;h<p;){for(var d=p,_=void 0;h<d;){var v=s.slice(h,d).join(""),g=this.trie.find(v);if(null!=g&&null!=g.end){_=g.getWord()[2];break}d-=1}if(null==_){c=!0;break}f.push(_),h=d}c?r.push(UNK_INDEX):r=r.concat(f)}return r},t}();function loadTokenizer(){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return[4,(t=new BertTokenizer).load()];case 1:return e.sent(),[2,t]}})})}var MODEL_URL="https://tfhub.dev/tensorflow/tfjs-model/mobilebert/1",INPUT_SIZE=384,MAX_ANSWER_LEN=32,MAX_QUERY_LEN=64,MAX_SEQ_LEN=384,PREDICT_ANSWER_NUM=5,OUTPUT_OFFSET=1,NO_ANSWER_THRESHOLD=4.3980759382247925,QuestionAndAnswerImpl=function(){function t(t){this.modelConfig=t,null==this.modelConfig&&(this.modelConfig={modelUrl:MODEL_URL,fromTFHub:!0}),null==this.modelConfig.fromTFHub&&(this.modelConfig.fromTFHub=!1)}return t.prototype.process=function(t,e,n,r,o){void 0===o&&(o=128),t=(t=t.replace(/\?/g,"")).trim(),t+="?";var i=this.tokenizer.tokenize(t);if(i.length>n)throw new Error("The length of question token exceeds the limit ("+n+").");for(var s=this.tokenizer.processInput(e.trim()),u=[],a=[],l=0;l<s.length;l++)for(var c=s[l].text,h=this.tokenizer.tokenize(c),f=0;f<h.length;f++){var p=h[f];u.push(l),a.push(p)}for(var d=r-i.length-3,_=[],v=0;v<a.length;){var g=a.length-v;if(g>d&&(g=d),_.push({start:v,length:g}),v+g===a.length)break;v+=Math.min(g,o)}return _.map(function(t){var e=[],n=[],o={};e.push(CLS_INDEX),n.push(0);for(var l=0;l<i.length;l++){var c=i[l];e.push(c),n.push(0)}e.push(SEP_INDEX),n.push(0);for(l=0;l<t.length;l++){var h=l+t.start,f=a[h];e.push(f),n.push(1),o[e.length]=u[h]}e.push(SEP_INDEX),n.push(1);for(var p=e,d=p.map(function(t){return 1});p.length<r;)p.push(0),d.push(0),n.push(0);return{inputIds:p,inputMask:d,segmentIds:n,origTokens:s,tokenToOrigMap:o}})},t.prototype.load=function(){return __awaiter(this,void 0,void 0,function(){var t,e,n,r,o;return __generator(this,function(i){switch(i.label){case 0:return t=this,[4,loadGraphModel(this.modelConfig.modelUrl,{fromTFHub:this.modelConfig.fromTFHub})];case 1:return t.model=i.sent(),e=ones([1,INPUT_SIZE],"int32"),n=ones([1,INPUT_SIZE],"int32"),r=ones([1,INPUT_SIZE],"int32"),this.model.execute({input_ids:e,segment_ids:n,input_mask:r,global_step:scalar(1,"int32")}),o=this,[4,loadTokenizer()];case 2:return o.tokenizer=i.sent(),[2]}})})},t.prototype.findAnswers=function(t,e){return __awaiter(this,void 0,void 0,function(){var n,r,o,i,s,u,a,l,c,h,f=this;return __generator(this,function(p){switch(p.label){case 0:if(null==t||null==e)throw new Error("The input to findAnswers call is null, please pass a string as input.");return n=this.process(t,e,MAX_QUERY_LEN,MAX_SEQ_LEN),r=n.map(function(t){return t.inputIds}),o=n.map(function(t){return t.segmentIds}),i=n.map(function(t){return t.inputMask}),s=scalar(1,"int32"),u=n.length,a=tidy(function(){var t=tensor2d(r,[u,INPUT_SIZE],"int32"),e=tensor2d(o,[u,INPUT_SIZE],"int32"),n=tensor2d(i,[u,INPUT_SIZE],"int32");return f.model.execute({input_ids:t,segment_ids:e,input_mask:n,global_step:s},["start_logits","end_logits"])}),[4,Promise.all([a[0].array(),a[1].array()])];case 1:for(l=p.sent(),s.dispose(),a[0].dispose(),a[1].dispose(),c=[],h=0;h<u;h++)c.push(this.getBestAnswers(l[0][h],l[1][h],n[h].origTokens,n[h].tokenToOrigMap,e,h));return[2,c.reduce(function(t,e){return t.concat(e)},[]).sort(function(t,e){return e.score-t.score}).slice(0,PREDICT_ANSWER_NUM)]}})})},t.prototype.getBestAnswers=function(t,e,n,r,o,i){var s;void 0===i&&(i=0);var u=this.getBestIndex(t),a=this.getBestIndex(e),l=[];u.forEach(function(n){a.forEach(function(o){r[n]&&r[o]&&o>=n&&(o-n+1<MAX_ANSWER_LEN&&l.push({start:n,end:o,score:t[n]+e[o]}))})}),l.sort(function(t,e){return e.score-t.score});for(var c=[],h=0;h<l.length&&!(h>=PREDICT_ANSWER_NUM||l[h].score<NO_ANSWER_THRESHOLD);h++){var f="",p=0,d=0;l[h].start>0?(f=(s=__read(this.convertBack(n,r,l[h].start,l[h].end,o),3))[0],p=s[1],d=s[2]):f="",c.push({text:f,score:l[h].score,startIndex:p,endIndex:d})}return c},t.prototype.getBestIndex=function(t){for(var e=[],n=0;n<MAX_SEQ_LEN;n++)e.push([n,n,t[n]]);e.sort(function(t,e){return e[2]-t[2]});var r=[];for(n=0;n<PREDICT_ANSWER_NUM;n++)r.push(e[n][0]);return r},t.prototype.convertBack=function(t,e,n,r,o){var i=r+OUTPUT_OFFSET,s=e[n+OUTPUT_OFFSET],u=e[i],a=t[s].index,l=u<t.length-1?t[u+1].index-1:t[u].index+t[u].text.length;return[o.slice(a,l+1).trim(),a,l]},t}();function load(t){return __awaiter(this,void 0,void 0,function(){var e;return __generator(this,function(n){switch(n.label){case 0:return[4,(e=new QuestionAndAnswerImpl(t)).load()];case 1:return n.sent(),[2,e]}})})}var version="1.0.0";export{load,version};
